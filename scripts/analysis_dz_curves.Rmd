---
title: "DZ TDP43 concentration dependent analysis"
author: "Matteo Zanovello"
date: "2022-01-10"
output:
---

```{r setup, include = False}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
if (!require("pacman")) {install.packages("pacman")}
if (!requireNamespace("BiocManager", quietly = TRUE)) {install.packages("BiocManager")}
pacman::p_load(tidyverse, data.table, janitor, ggpubr, ggrepel, magrittr, biomaRt, tximport,
               devtools, readxl, DESeq2, edgeR, annotables, rtracklayer, ensembldb,
               PCAtools, clusterProfiler, "org.Hs.eg.db", enrichplot, pcaExplorer, topGO, UpSetR,
               ggtranscript, "TxDb.Hsapiens.UCSC.hg38.knownGene", GenomicRanges)
            
#source(here::here('scripts','create_feature_count_table.R'))
#source(here::here('scripts','run_standard_deseq.R'))
source(here::here('scripts','salmon_deseq2.R'))
source(here::here('scripts','make_volcano_plot.R'))
source(here::here('scripts','splicing_volcanoplot.R'))
#source(here::here('scripts','trial_graph_concentration.R'))
#source(here::here('scripts','run_de_irfinder.R'))
#source(here::here('scripts','ggtranscript.R'))
```
###levels in qpcr
```{r}
#data from qpcr
levels_dz_qpcr <- fread("/Users/matteozanovello/Documents/phd/research_lines/tdp-43 curves/tdp curves dz/2022-05-04_145923_CURVES_DZ1.csv")
levels_dz_qpcr %>%
  filter(experiment == "new_new") %>%
  ggplot(aes(x = as.character(sample), y = 100*value)) +
  geom_point() +
  geom_boxplot() +
  xlab(expression(paste('Doxycycline concentration (', mu,'g/mL)'))) +
  ylab('TDP-43 levels compared to untreated (%)') +
  #facet_wrap(facets = vars(experiment)) +
  theme_classic() +
  theme(text = element_text(size = 24))
#ggsave(file = "~/Desktop/qpcr_dz_curves.png", width = 8)

levels_sy5y_qpcr <- fread("/Users/matteozanovello/Documents/phd/research_lines/tdp-43 curves/unc13a_b_tdp43_curves_nature_paper.csv")
levels_sy5y_qpcr %>%
  #filter(experiment == "new") %>%
  ggplot(aes(x = as.character(Treatment), y = Value)) +
  geom_point() +
  geom_boxplot() +
  xlab(expression(paste('Doxycycline concentration (', mu,'g/mL)'))) +
  ylab('TDP-43 levels compared to untreated (%)') +
  #facet_wrap(facets = vars(experiment)) +
  theme_classic() +
  theme(text = element_text(size = 24))
#ggsave(file = "~/Desktop/qpcr_sy_curves.png", width = 8)
#levels_dz_qpcr %>%
#  group_by(experiment,sample) %>%
#  summarise_at(vars(value),list(name = mean))
```

this organizes all the data from the many .bam files and creates one data frame you can work with,
then runs the make_deseq_dfs() function and run_standard_deseq() and eventually make graphs
```{r}
sample_dir_dz <- "~/Documents/GitHub/tdp43_concentration/data/salmon_quant_dz/"
metadata_dir_dz <- fread("~/Documents/GitHub/tdp43_concentration/data/metadata_dz_curves.csv")
levels_dz = c(0.02, 0.03, 0.04, 0.05, 0.075, 0.1, 1)

for (j in levels_dz) {
  salmon_deseq2(j, sample_dir_dz, metadata_dir_dz)
  bbb <- label_significant(results_table, log2FoldCut = 2, log10padj = 5) + annotate("text", x=0.9, y=0.1, label=j)
  #plot(bbb)
  assign(paste0("normed_counts_dz_curves_",j), normed_counts)
  assign(paste0("results_table_dz_curves_",j), results_table)
}

AppendMe <- function(dfNames) {
  do.call(rbind, lapply(dfNames, function(x) {
    cbind(get(x), source = x)
  }))
}

#funnel plot with differential gene expression
list_de_dz <- paste0("results_table_dz_curves_", levels_dz)
big_delta_de_dz <- AppendMe(list_de_dz) 
big_delta_de_dz$source <- factor(big_delta_de_dz$source, levels = list_de_dz, labels = levels_dz)
list_gene <- c("UNC13A", "STMN2"#, "AARS", #"UNC13B", 
               #"CELF5", "ELAVL3", "INSR", "ATG4B", #"KCNQ2", #"RANBP1", 
               #"NUP188","SYT7", #"WASL",
                #"RAB1GAP", #"AGRN","PFKP", 
                 #"HDGFL2","ARHGAP32", "CEP290", "PRELID3A", "KALRN",
                 #"CAMK2B", "ADCY1", "TRAPPC12", "EPB41L4A", "IQCE", "SEMA4D"
                 #"CYFIP2", "SYNE1"
               )

write.table(big_delta_de_dz, file = "~/Desktop/diff_expr_sk.csv", sep = ",", row.names = F) #"normed_counts_dz_all.csv")

plot_de_dz <- big_delta_de_dz %>%
  mutate(color_gene_name = ifelse(log2FoldChange > 0, "up","down")) %>%
  mutate(alpha_gene_name = ifelse(padj < 0.05, "sig", "non_sig")) %>%
  mutate(gene_label = case_when(symbol %in% list_gene & alpha_gene_name == "sig" ~ symbol, T ~ ""))
plot_de_dz_meta <- as.data.frame(table(plot_de_dz$color_gene_name, plot_de_dz$alpha_gene_name, plot_de_dz$source))

plot_de_dz %>%
  ggplot(aes(x = log2FoldChange, y = source)) +
  geom_point(aes(color = color_gene_name, alpha = alpha_gene_name),
             size = 0.2,
             position = position_jitter(width = 0, height = 0.4),
             show.legend = F) +
  geom_text(data = plot_de_dz_meta[plot_de_dz_meta$Var2 == "sig",], 
            aes(x = ifelse(Var1 == "down", -8, 8), y = Var3, label = Freq, color = Var1),
            size = 5,
            show.legend = F) +
  geom_vline(xintercept = 0) +
  geom_text_repel(aes(label = gene_label), max.overlaps = Inf) +
  #coord_flip() +
  scale_color_brewer(palette = "Set1") +
  scale_alpha_manual(values = c(0.2, 1)) +
  xlab('Log2 Fold Change compared to untreated') +
  ylab('Doxycycline concentration (ug/mL)') +
  xlim(c(-10,10)) +
  theme_classic() 


salmon_deseq2(levels_dz, sample_dir_dz, metadata_dir_dz)
assign("normed_counts_dz_curves", normed_counts)

write.table(normed_counts_dz_curves, "~/Desktop/normed_counts_sk.csv", sep = ",",  row.names = F)

#write.csv(normed_counts_dz_curves, file = "~/Documents/GitHub/tdp43_concentration/results/normed_counts_dz/normed_counts_dz_all.csv") #"normed_counts_dz_all.csv")
normed_counts_long_dz <- normed_counts_dz_curves[,c(2:25,27)] %>% 
  #dplyr::filter(symbol == "TARDBP" | symbol == "UPF1" | symbol == "INSR") %>%
  pivot_longer(c(1:24)) %>%
  mutate(group = gsub("^[^_]+_|_[^_]+$", "", name))

normed_counts_long_dz %>%
  dplyr::filter(symbol == "TARDBP" | symbol == "STMN2" | symbol == "AARS" | symbol == "UNC13A" |
                  symbol == "SYNE1" | symbol == "CYFIP2") %>%
  ggplot(aes(x = group, y = value, color = symbol)) +
  geom_boxplot(alpha = 0.1, show.legend = F) +
  geom_point(position = position_dodge2(width = 1), show.legend = F) +
  #stat_pvalue_manual(stattest, hide.ns = T) + #[c(1,2),]) +
  #scale_y_log10() +
  facet_wrap(facets = vars(symbol), scales = "free_y") +
  scale_color_brewer(palette = "Set1") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))
```

```{r}
#density plot
normed_counts_long_dz %>%
  ggplot(aes(x = value, color = group)) +
  geom_histogram(aes(y=..density..), colour="black", fill="white") +
  geom_density() +
  facet_wrap(facets = vars(group), nrow = 2) +
  scale_color_brewer(palette="Set1") +
  scale_x_log10() +
  labs(x = expression(paste("Lo", g[10], " counts")), y = "Density", color = "Group") +
  theme_classic()

mean_counts <- normed_counts_long_dz %>%
  group_by(group, symbol) %>%
  mutate(meanz = mean(value)) %>%
  mutate(varz = var(value))

mean_counts %>% 
  ggplot(aes(x=meanz, y=varz, color = group)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, color="black") +
  facet_wrap(facets = vars(group), nrow = 2) +
  scale_color_brewer(palette="Set1") +
  scale_x_log10() +
  scale_y_log10() +
  theme_classic()

#quantile-quantile plot
normed_counts_long_dz %>%
  ggplot(aes(sample = value, color = group)) +
  geom_qq() + ###??
  geom_qq_line() + ###??
  facet_wrap(facets = vars(group), nrow = 2) +
  scale_color_brewer(palette="Set1") +
  #scale_x_log10() +
  theme_classic()

### pca analysis
pca_dz <- normed_counts_dz_curves[,c(1:25)] %>%
  #arrange(CTRL_ctrl_1) %>% ####can be better?
  distinct(Geneid, .keep_all = TRUE) %>%
  #select(c(1:)) %>%
  column_to_rownames('Geneid')
  #column_to_rownames('ensgene') #%>% t()

meta_df <- metadata_dir_dz %>% 
  #mutate(condition = factor(condition, levels = c(0,1))) %>%
  #mutate(treatment = factor(treatment, levels = c(0,1))) %>%
    #mutate(group = gsub("_[^_]+$", "", sample)) %>%
   mutate(level = as.character(level)) %>%
    column_to_rownames('sample') 

pp <- PCAtools::pca(pca_dz, metadata = meta_df, removeVar = 0.1)
screeplot(pp, axisLabSize = 18, titleLabSize = 22)
PCAtools::eigencorplot(pp,components = getComponents(pp),
                       metavars = c('condition',"level"))
#nice pca plot
biplot(pp,
       x = "PC1",
       y = "PC2",
       colby = 'level')
```


splicing volcano and upset plot
```{r}
#base <- "Control"
contrast <- c("TDP43KD002", "TDP43KD003", "TDP43KD004", "TDP43KD005", "TDP43KD0075", "TDP43KD01", "TDP43KD1")
datalista <- list()

for (i in contrast) {
  input_bc_splicing <- fread(paste0("~/Documents/GitHub/tdp43_concentration/data/majiq_dz/Control-", i, "_annotated_junctions.csv"))
  names(input_bc_splicing)[12] <- "base_mean_psi"
  names(input_bc_splicing)[13] <- "contrast_mean_psi"
  assign(paste0("DS_",i), input_bc_splicing)
  a <- splicing_dots_tables_function(input_bc_splicing) + annotate("text", x=0.9, y=0.1, label=i)
  #plot(a)

  datalista[[i]] <- input_bc_splicing
}
big_delta_dz <- rbindlist(datalista, idcol = TRUE)
big_delta_dz$.id <- factor(big_delta_dz$.id, levels = contrast)



input_list <- c("DZ_curves_0","DZ_curves_002", "DZ_curves_003", "DZ_curves_004", "DZ_curves_005", "DZ_curves_0075", "DZ_curves_01", "DZ_curves_1")
datalist <- list()

for (i in input_list) {
  input_splicing <- fread(paste0("~/Documents/GitHub/tdp43_concentration/data/majiq_dz/", i, "_parsed.csv"))
  datalist[[i]] <- input_splicing
}
big_data <- rbindlist(datalist, idcol = TRUE)
big_data$.id <- factor(big_data$.id, levels = input_list)


###change to novel script
#spaghetti_plot(big_data)
#spaghetti_plot_normal(big_data)

```


```{r}
big_data_matrix_dz = big_delta_dz %>%
  filter(junc_cat != "annotated") %>%
  mutate(is_a_cryptic = base_mean_psi < 0.05 & mean_dpsi_per_lsv_junction > 0.1) %>%
           #abs(mean_dpsi_per_lsv_junction) > 0.15 & probability_changing > 0.9) %>% # 
  mutate(name = glue::glue("{gene_name}|{junc_cat}|{paste_into_igv_junction}")) %>%
  dplyr::select(name,is_a_cryptic,.id) %>%
  unique() %>%
  filter(is_a_cryptic == T)%>% 
  pivot_wider(values_from = "is_a_cryptic",
              id_cols = "name",
              names_from = ".id",
              values_fill = FALSE, values_fn = sum) %>%
  column_to_rownames('name') %>%
  mutate_all(as.logical)
  
upset(big_data_matrix_dz * 1, nsets = 7,
      order.by = "freq", keep.order = T, nintersects = 23,
      mainbar.y.label = "Junction Intersections", 
      sets.x.label = "Junction Per Level of TDP-43 KD")
```
