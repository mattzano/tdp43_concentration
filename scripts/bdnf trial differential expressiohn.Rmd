---
title: "TDP43 concentration dependent analysis"
author: "Matteo Zanovello"
date: "2022-01-10"
output:
---

```{r setup, include = False}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
if (!require("pacman")){
    install.packages("pacman")
} #if pacman is not installed, install it
pacman::p_load(tidyverse, data.table, ggplot2, janitor, ggpubr, ggrepel,
               devtools, readxl, DESeq2, readr, edgeR, annotables)
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
library(PCAtools)
library(clusterProfiler)
library(org.Hs.eg.db)
library(enrichplot)
```

this organizes all the data from the many .bam files and creates one data frame you can work with,
then runs the make_deseq_dfs() function and run_standard_deseq() and eventually make graphs
```{r}
source(here::here('scripts','feature_count','create_feature_count_table.R'))
featureCounts <- create_feature_count_table("/Users/matteozanovello/Documents/phd/research_lines/tdp43_concentration/data/feature_count") #change here!!

source(here::here('scripts','feature_count','make_deseq_dfs.R'))
my_df <- make_deseq_dfs(featureCounts, grep_pattern = "", base_grep = "NT", contrast_grep = "DOX")

source(here::here('scripts','feature_count','run_standard_deseq.R'))
my.dds <- run_standard_deseq("/Users/matteozanovello/Documents/phd/research_lines/tdp43_concentration/data/feature_count", 
                             base_grep = "NT",
                             contrast_grep = "DOX",  
                             grep_pattern = "",
                             baseName = "Untreated",
                             contrastName = 'TDP43KD')

source(here::here('scripts','feature_count','make_volcano_plot.R'))
label_significant(my.dds$results_table, log2FoldCut = 2, log10padj = 5)
```

#splicing volcano
```{r}
source(here::here('scripts','splicing_volcanoplot.R'))
input_splicing <- fread(file.path(here::here(), "data", "noDox-dox00187.csv"))
input_splicing <- separate_rows(input_splicing, c(mean_dpsi_per_lsv_junction, probability_changing, 
                                                                 probability_non_changing, noDox_mean_psi, 
                                                                 dox00187_mean_psi, lsv_type, de_novo_junctions, 
                                                                 junctions_coords), sep = c(";"), convert = T)

splicing_dots_tables_function(input_splicing)

```

This is the vignette for the PCAtools package
https://bioconductor.org/packages/release/bioc/vignettes/PCAtools/inst/doc/PCAtools.html

We're going to put the "ensgene" into a 'rowname' and then do the PCA analysis using meta data
Now I'm going to write this using the pipe operator "%>%". Your "hot key" to type that in is: Ctrl + Shift + M
```{r}
bdnf_counts <- featureCounts
colnames(bdnf_counts) <- c("ensgene", 
                           "NT_0_1", "NT_0_2", "NT_0_3", 
                           #"DOX_0.0125_1", "DOX_0.0125_2", "DOX_0.0125_3",
                           "DOX_0.0187_1", "DOX_0.0187_2", "DOX_0.0187_3",
                           #"DOX_0.021_1", "DOX_0.021_2", "DOX_0.021_3", 
                           #"DOX_0.025_1", "DOX_0.025_2", "DOX_0.025_3", 
                           #"DOX_0.075_1", "DOX_0.075_2", 
                           "symbol")

pca_table <- bdnf_counts[,1:7] %>% 
    column_to_rownames('ensgene')

path_to_meta_you_downloaded <-  "/Users/matteozanovello/Documents/phd/research_lines/tdp43_concentration/data/metadata.csv" #update this
meta_df <- fread(path_to_meta_you_downloaded)
meta_df <- meta_df[c(1:3,7:9)] #update this
meta_df <- meta_df %>% 
    column_to_rownames('sample') 

p <- PCAtools::pca(pca_table, metadata = meta_df, removeVar = 0.1)
screeplot(p, axisLabSize = 18, titleLabSize = 22)
```

Now we're going to make what is called an "eigencorplot"
This is going to correlate our metadata variables with our principle components. 
```{r}
PCAtools::eigencorplot(p, components = getComponents(p),
                       metavars = c('condition',"level"))
```

We can do a biplot with the 2 PC's that are correlating
```{r}
biplot(p,
       x = "PC1", #0.72 with level
       y = "PC6", #0.97 with condition
       colby = c('level'))
```

Let's go ahead and find out what the genes are that are correlated with PC2.
Let's directly take the loadings of each of the genes (a PCA is a linear combination),
making use of the wonder of `left_join`. Then do the same with the original count table
```{r}
pc1_gene_loadings = p$loadings %>% 
    dplyr::select(PC1) %>% 
    rownames_to_column('ensgene') %>% 
    left_join(annotables::grch38 %>% dplyr::select(c(ensgene))) %>% 
#https://statisticsglobe.com/r-dplyr-join-inner-left-right-full-semi-anti
    arrange(-PC1)

bdnf_counts %>% 
    left_join(annotables::grch38 %>% dplyr::select(c(ensgene,symbol))) %>% 
    left_join(pc1_gene_loadings %>% head(12)) %>%
    filter(!is.na(PC1)) %>%
    dplyr::select(-ensgene) %>% 
    melt(id.vars = c("symbol","PC1")) %>%
    mutate(ensgene = fct_reorder(symbol,-PC1)) %>% 
    separate(variable, into = c("condition","level")) %>%
    ggplot(aes(x = condition, y = value, fill = level)) + 
    geom_col(position = "dodge2") + facet_wrap(~symbol)

```

GO analysis https://yulab-smu.top/biomedical-knowledge-mining-book/clusterprofiler-go.html
#see notes above
```{r}
results <- my.dds$results_table
filtered_res <- filter(results, padj < 0.1 & abs(log2FoldChange) > 2)
## feature 1: numeric vector
geneList <- pull(filtered_res,3)
## feature 2: named vector
names(geneList) = as.character(pull(filtered_res,8))
## feature 3: decreasing order
geneList = sort(geneList, decreasing = TRUE)

ggo <- groupGO(gene = names(geneList),
               OrgDb = org.Hs.eg.db,
               keyType = "SYMBOL",
               ont = "CC",
               level = 3)
```

```{r}
ego <- enrichGO(gene = names(geneList),
                keyType = "SYMBOL",
                OrgDb = org.Hs.eg.db,
                ont = "CC",
                pAdjustMethod = "BH",
                pvalueCutoff = 0.01,
                qvalueCutoff = 0.05)
goplot(ego)
```

```{r}
pgo <- pairwise_termsim(ego)
emapplot(pgo)
```

```{r}
gse <- gseGO(geneList     = geneList,
              keyType = "SYMBOL",
              OrgDb        = org.Hs.eg.db,
              ont          = "CC",
              minGSSize    = 50,
              maxGSSize    = 200,
              pvalueCutoff = 0.01,
              verbose      = FALSE)
```